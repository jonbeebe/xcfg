<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/xcfg.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/jonbeebe/xcfg" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/xcfg.js~Xcfg.html">Xcfg</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/xcfg.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

let os = require(&apos;os&apos;)
let path = require(&apos;path&apos;)
let fs = require(&apos;fs&apos;)

const DIR_MODE = parseInt(&apos;0700&apos;, 8)
const FILE_MODE = parseInt(&apos;0600&apos;, 8)

/**
 * Xcfg class
 */
class Xcfg {
  /**
   * Creates a new Xcfg instance, initializes config directory structure and
   * prepares a blank config file if it doesn&apos;t exist.
   *
   * @param {string} id - Identifier (used to create config directory in ~/.config), sanitized with: `id.replace(/[/?&lt;&gt;\\:*|&quot; :]/g, &apos;.&apos;).replace(/\.+/g, &apos;.&apos;)`
   * @param {Object} options - options to change default behavior.
   * @param {string} options.confdir - override directory name (default: `&apos;.config&apos;`)
   * @param {number} options.dir_mode - override directory file mode (default: `parseInt(&apos;0700&apos;, 8)`).
   * @param {number} options.file_mode - override file mode (default: `parseInt(&apos;0600&apos;, 8)`).
   * @param {string} options.filename - override file name (default: `&apos;config.json&apos;`).
   * @param {boolean} options.minify - when saving config, minify the output (default: `false`).
   */
  constructor (id, options = {}) {
    // sanitize id
    this._id = id.replace(/[/?&lt;&gt;\\:*|&quot; :]/g, &apos;.&apos;).replace(/\.+/g, &apos;.&apos;)

    // check options
    let confDir = options.confdir || &apos;.config&apos;
    let dirMode = options.dir_mode || DIR_MODE
    let filename = options.filename || &apos;config.json&apos;
    this._file_mode = options.file_mode || FILE_MODE
    this._minify = !!options.minify

    // Create directory structure (same as mkdir -p)
    let dirParts = [os.homedir(), confDir, this._id]
    let dirPath = dirParts.reduce((acc, val) =&gt; {
      let currPath = acc + path.sep + val
      if (!fs.existsSync(currPath)) {
        fs.mkdirSync(currPath, dirMode)
      }
      return currPath
    })

    // Create config.json if it doesn&apos;t exist
    this._file_path = path.join(dirPath, filename)
    if (!fs.existsSync(this._file_path)) {
      let fd = fs.openSync(this._file_path, &apos;w&apos;, this._file_mode)
      if (fd) {
        fs.closeSync(fd)
      } else {
        throw new Error(&apos;There was a problem opening &apos; + this._file_path)
      }
    }

    this._data = {} // holds data that will be written to config.json
  }

  /**
   * Returns the sanitized version identifier that was passed to the constructor.
   *
   * @returns {string} - this id was used to create the config directory in ~/.config
   */
  id () {
    return this._id
  }

  /**
   * Returns value at provided key.
   *
   * @param {string} key - retrieve the data stored at this key.
   * @returns {any} the data at the provided key.
   */
  get (key) {
    checkKey(&apos;get&apos;, key)
    return this._data[key]
  }

  /**
   * Store data at provided key and optionally save (async) to disk.
   *
   * @param {string} key - store data at this key.
   * @param {any} value - data to store at provided key.
   * @param {boolean} shouldSave - save to disk (default: `false`).
   * @param {function} callback - function to call if `shouldSave` is set to `true`
   */
  set (key, value = &apos;&apos;, shouldSave = false, callback) {
    checkKey(&apos;set&apos;, key)
    this._data[key] = value
    if (shouldSave) {
      this.save(callback)
    }
  }

  /**
   * Delete data at provided key and optionally save (async) to disk.
   *
   * @param {string} key - delete the data at this key.
   * @param {boolean} shouldSave - save to disk (default: `false`).
   * @param {function} callback - function to call if `shouldSave` is set to `true`
   */
  del (key, shouldSave = false, callback) {
    checkKey(&apos;del&apos;, key)
    delete this._data[key]
    if (shouldSave) {
      this.save(callback)
    }
  }

  /**
   * Delete data at all keys optionally save (async) to disk.
   *
   * @param {boolean} shouldSave - save to disk (default: `false`).
   * @param {function} callback - function to call if `shouldSave` is set to `true`
   */
  deleteAll (shouldSave = false, callback) {
    this._data = {}
    if (shouldSave) {
      this.save(callback)
    }
  }

  /**
   * Saves config data to disk.
   *
   * @param {function} callback - function to call after save operation.
   */
  save (callback) {
    let saveData
    if (this._minify) {
      saveData = JSON.stringify(this._data)
    } else {
      saveData = JSON.stringify(this._data, null, 2)
    }

    fs.writeFile(this._file_path, saveData, {
      &apos;mode&apos;: this._file_mode,
      &apos;flag&apos;: &apos;w&apos;
    }, callback)
  }
}

function checkKey (method, key) {
  if (!key || typeof key !== &apos;string&apos;) {
    throw new Error(&apos;Xcfg &apos; + method + &apos;() key must be a string&apos;)
  }
}

module.exports = Xcfg
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
